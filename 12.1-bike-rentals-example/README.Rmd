---
title: "The Bike Rental Boom Is Here"
author: "Peter Spangler"
output: 
  github_document: 
    toc: yes
    toc_depth: 5
---


```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)

# create image folder ----
if (!file.exists("images/")) {
    dir.create("images/")
}
# create data folder ----
if (!file.exists("data/")) {
    dir.create("data/")
}

# knitr settings chunk ------
knitr::opts_chunk$set(
    echo = TRUE, # show all code
    tidy = FALSE, # cleaner code printing
    size = "small", # smaller code
    fig.path = "images/") 

#  knitr settings entire doc ------
knitr::opts_knit$set(
    width = 78)

base::options(tibble.print_max = 25,
              tibble.width = 78)
```

# Motivation: Predicting Bike Rental Behaviour in a Metropolitan City

> TLDR:

```{r packages, message=FALSE, warning=FALSE}
# packages --------------------------------------------------------------
library(tidyverse)
library(rsample) # data splitting
library(randomForest) # basic implementation
library(ranger) # a faster implementation of randomForest
library(caret) # an aggregator package for performing many machine learning models
library(ggthemes)
library(scales)
library(wesanderson)
library(styler)
```

Bikes have become one of the fastest growing modes of city travel and transportation disruptors Lyft and Uber have expanded their offerings. [Lyft’s recent acquisition of Motivate](https://www.nytimes.com/2018/07/02/business/dealbook/lyft-citibike-motivate-bike-share.html), the largest bike rental company in the world, will compete with Uber’s Jump and Ford’s GoBikes which have delivered [625,000 and 1.4 million rides](https://techcrunch.com/2019/02/08/ubers-jump-bikes-are-seeing-high-utilization-rates/) in San Francisco, respectively. The growth of alternative forms of transportation presents a unique challenge for both the companies offering these services and the cities responding to the scale of change, particularly in the area of forecasting demand. 

“For sure congestion has been getting worse,” said Joe Castiglione, Transportation Authority deputy director for technology, data, and analysis. 
“The question we tried to answer is, do (Uber and Lyft) affect congestion in San Francisco and by how much?” The answer, the report said, is “yes” and “by about 50 percent.”
- [source](https://www.sfchronicle.com/business/article/Uber-Lyft-cars-clog-SF-streets-study-says-13309593.php)

*The technique we used to answer these questions* was a gradient boosting machine (GBM). GBM is similar to other ensemble models in that it builds improved accuracy by building multiple models. <!-- The idea of the gradient boosting is to create a series of decision trees, with each new tree attempting to increase its performance over previous decision tree on the misclassified observations. --> Where GMB is unique compared to other tree algorithms like a random forest is that it builds models sequentially with higher weights given to those cases that were badly predicted in previous models. GBM improves accuracy incrementally instead of simply taking an average of all models like in random forest. By reducing the error iteratively to produce what will become the final model, GBM is an efficient and powerful algorithm for classification and regression problems. Implementing GBM in R allows for a nice selection of exploratory plots including parameter contribution, and partial dependence plots which provide a visual representation of the effect across values of a feature in the model.

In this article we will use data from Capital Bikeshare available at the [UCI Machine Learning Repository to model bike rentals from 2011 - 2012](https://archive.ics.uci.edu/ml/datasets/bike+sharing+dataset) in Washington, D.C. We were curious what the major predictors were for people renting bikes over the course of the year. The data we have includes measurements on weather conditions (temperature, humidity, wind speed, etc.), how many bikes were rented, and other seasonal attributes that might influence rentals (i.e. weekdays and holidays). Curiously, riders are more likely to rent a bike after Monday despite temperature and the likelihood increases on Saturdays when temperatures are between 15  to 25 degrees celsius. 


# Import data

This code will import the daily bike rental data in the `data` folder. 

```{r import-bike}
# read data of bike rentals daily ----
bike <- read.csv("data/day.csv")
```

# Wrangle

The script for wrangling the data is available [here])().  prepares the data for modeling. Read through the comments to understand why each step was taken, and how these variables get entered into the visualizations and models. 

```{r wrangle, include=TRUE, eval=TRUE, echo=TRUE}
# fs::dir_ls("code")
source("code/02-wrangle.R")
BikeData %>% glimpse(78)
```

***

# Exploratory Data Analysis (tables)

Three options for summarizing the `bike` table into summary statistics that will give us a better understanding of the underlying distribution for each variable in the `BikeData` data frame. 

## dplyr (#1)

Check out the dplyr package [here]()

```{r BikeDplyrSummary, message=FALSE, warning=FALSE, results='hold'}
# create exploratory analysis table for continuous data
BikeDplyrSummary <- BikeData %>%
  select(temp, atemp, hum, windspeed, casual, registered, cnt) %>%
  summarise_each(list(
    min = ~min,
    q25 = ~quantile(., 0.25),
    median = ~median,
    q75 = ~quantile(., 0.75),
    max = ~max,
    mean = ~mean,
    sd = ~sd
  )) %>%
  gather(stat, val) %>%
  separate(stat, 
           into = c("var", "stat"), 
           sep = "_") %>%
  spread(stat, val) %>%
  select(var, min, q25, median, q75, max, mean, sd)

knitr::kable(BikeDplyrSummary)
```

## skimr (#2)

Check out the skimr package [here]()

```{r BikeSkimrSummary, results='hold'}
# skimr::skim() ----
BikeSkimrSummary <- bike %>%
  skimr::skim_to_wide() %>%
  dplyr::select(type,
    variable,
    missing,
    complete,
    min,
    max,
    mean,
    sd,
    median = p50,
    hist)
knitr::kable(BikeSkimrSummary)
```

## mosaic::inspect (#3)

Check out the mosaic package [here]()

```{r bike_inspect, results='hold'}
# mosaic::inspect -----------------------------------------------------
BikeMosaicInspect <- mosaic::inspect(bike)
# categorical
knitr::kable(BikeMosaicInspect$categorical)
```

```{r inspect-Date, results='hold'}
# categorical
knitr::kable(BikeMosaicInspect$Date)
```


```{r inspect-quantitative}
# categorical
knitr::kable(BikeMosaicInspect$quantitative)
```

*** 


Bike riders have the opportunity to avoid many of the limitations of car traffic--bikers can ride in special travel lanes, they can quickly move between vehicles, and can avoid the road altogether by riding on the sidewalk. However, unlike rideshare passengers, bikers are vulnerable to weather conditions, and this might impact their likelihood of choosing a bike over other transportation options. 

If weather conditions are influential in transportation decisions, we would expect to see relationships between the number of bike rentals and weather features including temperature, humidity and wind speed.    

## Graph1: Bike Rental Volume By Temperature

We would expect riders to choose a car (or other means of transportation) if its too cold. 

```{r ggRentalsByTemp}
# ~ rentals by temperature ----
ggRentalsByTemp <- bike %>% 
  ggplot(aes(y = cnt, 
                 x = temp, 
                 color = weekday_fct)) +
  geom_point(show.legend = FALSE) +
  geom_smooth(se = FALSE,
              show.legend = FALSE) +
  facet_grid(~weekday_fct) +
  scale_color_brewer(palette = "Dark2") +
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) +
  ylab("Bike Rentals") +
  xlab("Temperature (°C)") +
  ggtitle("Bike Rental Volume By Temperature")
ggRentalsByTemp
```

The output below is R's way of telling us how the best-fit line is being drawn through each set of data. 

```r
`geom_smooth()` using method = 'loess' and formula 'y ~ x'
```

## Graph2: Bike Rental Volume By Wind Speed

We would also expect windier conditions to negatively impact bike rentals.

```{r ggRentalVolByWindSpeed}
# ggRentalVolByWindSpeed ----
ggRentalVolByWindSpeed <- ggplot(bike) +
  geom_point(aes(y = cnt, 
                 x = windspeed, 
                 color = weekday_fct),
             show.legend = FALSE) +
  facet_grid(~weekday_fct) +
  scale_color_brewer(palette = "Dark2") +
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) +
  ylab("Bike Rentals") +
  xlab("Windspeed") +
  ggtitle("Rental Volume By Windspeed")
ggRentalVolByWindSpeed
```


Holidays might influence bike riders in different ways. For instance, we can think of holidays as increasing opportunities for bike riders to enjoy being on the road with fewer drivers, since typically fewer people drive on holidays. We could also consider a situation where bike enthusiasts only prefer to ride their bikes on summer or spring holidays (considering the information we've learned about the influences of weather conditions on bike rentals).

## Graph3: Bike Rental Density By Holiday vs Non-Holiday


```{r ggRentalVolByHoliday}
ggRentalVolByHoliday <- ggplot(BikeData) +
  geom_density(aes(x = cnt,
                   fill = holiday_chr), 
                   alpha = 0.2) +
  scale_fill_brewer(palette = "Paired") +
  
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) + 
  labs(title = "Bike Rental Density By Holiday",
               fill = "Holiday",
               x = "Average Bike Rentals",
               y = "Density")

ggRentalVolByHoliday
```

***

With Lyft and Uber preparing for an [Initial public offering (IPO)](https://en.wikipedia.org/wiki/Initial_public_offering) this year and rideshare growth hitting one billion and 10 billion rides completed respectively, the market of transportation has been disrupted in cities across the country and around the world. How this evolution will impact greener forms of transportation like bikes will in part be determined by the ability of companies and cities to plan and execute on accommodating demand. The recent [San Francisco rideshare tax](https://www.sfchronicle.com/bayarea/philmatier/article/Things-look-good-for-SF-Supervisor-Peskin-s-13693183.php) is a manifestation of an absence of this execution. As more people choose alternative transportation forecasting the shift will be an important component for transportation leaders like Castiglione.  




